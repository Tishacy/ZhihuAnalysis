<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=0.8" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<title>Zhihu Analysis</title>
        <link rel="stylesheet" href="./css/style.css" />
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <!-- <script src="js/jquery.scrollUp.min.js"></script> -->
        <script src="js/app.js"></script>
	</head>
	<body>
		<header class="analysis-header">
			<a href="/">Zhihu Analysis</a>
			<div class="question-container">
				<h3 class="question"></h3>
			</div>
		</header>
		<div class="main-container">
			<div class="images-list" id="waterfall-container">
                <!-- <div href="javascript:;" class="image-container waterfall-item">
                    <div class="image-wrapper">
                        <img src="https://pic1.zhimg.com/v2-c42cec95276e7f5c44bb8744848c0963_r.jpg" alt="" data-src="${imageUrl}"/>
                        <div class="info-container">
                            <div href="javascript:;" class="avatar-wrapper">
                                <img class="avatar" src="https://pic2.zhimg.com/v2-ed035e93b2a884db45111aa71bcb1010_l.jpg" alt="" onerror="this.src='./static/avatar_template.jpg'">
                            </div>
                            <span class="author" title="tishacy&chayatish">tishcay&chayatish</span>
                            <span class="voteup"><i></i>5</span>
                        </div>
                    </div>
                </div> -->
			</div>
        </div>
        <div class="side">
            <button class="back-to-top" title="回到顶部">
                <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M16.036 19.59a1 1 0 0 1-.997.995H9.032a.996.996 0 0 1-.997-.996v-7.005H5.03c-1.1 0-1.36-.633-.578-1.416L11.33 4.29a1.003 1.003 0 0 1 1.412 0l6.878 6.88c.782.78.523 1.415-.58 1.415h-3.004v7.005z"></path></svg>
            </button>
        </div>
        <footer style="display: none;">
            <p>-- 没有更多了 --</p>
        </footer>

    </body>
	<script>
        // const questionId = getQuestionId();
        // fetch(`/api?id=${questionId}`)
        // .then(res => res.json())
        // .then(data => console.log(data));
        
        const waterFall = new WaterFall({
            container: $("#waterfall-container")[0],
            items: $(".waterfall-item"),
            cols: 4
        });
        let query = getQuery();
        query.limit = 1;
        query.offset = 0;

        async function getFirstBatch (query) {
            const json = await getBatch(query);
            const imageInfos = await json.data;
            let minHeight = Math.min(...waterFall.heightArr);
            let maxHeight = Math.max(...waterFall.heightArr);
            minHeight = (minHeight == Infinity || minHeight == -Infinity)? 0 : minHeight;
            maxHeight = (maxHeight == Infinity || maxHeight == -Infinity)? 0 : maxHeight;
            // console.log(waterFall.heightArr, minHeight, maxHeight);

            // 如果图片数量太少，就增加 query.limit
            if (imageInfos.length < 10) {
                query.limit = 15;
            }
            if (minHeight < 500) {
                query.offset += query.limit;
                getFirstBatch(query);
            }
        }
        getFirstBatch(query);

        async function getBatch(query) {
            console.log(`getting batch: ${query.offset}`);
            const apiUrl = formatAPIUrl('/api', query);
            const res = await fetch(apiUrl);
            const json = await res.json();
            const question = json.question;
            const imageInfos = json.data;

            $('h3.question').text(question.title);
            imageInfos.forEach((imageInfo, index) => {
                const imageUrl = imageInfo.imageUrl;
                const avatarUrl = imageInfo.author.avatar_url;
                const authorName = imageInfo.author.name;
                const authorUrlToken = imageInfo.author.url_token;
                const voteupCount = imageInfo.voteupCount;
                const $waterFallItem = $(`<div href="javascript:;" class="image-container waterfall-item">
                        <div class="image-wrapper">
                            <img src="" class="pic" alt="" data-src="${imageUrl}"/>
                            <div class="info-container" style="">
                                <a href="https://www.zhihu.com/people/${authorUrlToken}/activities" target="_blank" class="avatar-wrapper">
                                    <img class="avatar" src="${avatarUrl}" alt="" onerror="this.src='./static/avatar_template.jpg'">
                                </a>
                                <a href="https://www.zhihu.com/people/${authorUrlToken}/activities" target="_blank" class="author" title="${authorName}">${authorName}</a>
                                <span class="voteup"><i></i>${voteupCount}</span>
                            </div>
                        </div>
                </div>`)
                const $waterFallImage = $waterFallItem.find('img.pic');
                $waterFallItem.css({
                    'visibility': 'hidden'
                });

                $('#waterfall-container').append($waterFallItem);
                $waterFallImage.attr('src', $waterFallImage.attr('data-src'));
                $waterFallImage.on('load', function () {
                    $waterFallItem.css({
                        'visibility': 'visible'
                    });
                    waterFall.appendItem($waterFallItem[0]);
                    waterFall.organize();
                });
                $waterFallImage.on('error', function () {
                    // 加载失败时就隐藏该区块
                    $(this).parents('.waterfall-item').css({
                        'display': 'none'
                    })
                })
            })
            return json;
        }
        function getQuery() {
            const params = document.location.search.slice(1).split('&');
            const query = {};
            for (let param of params) {
                param = param.split('=');
                query[param[0]] = param[1]
            }
            return query;
        }
        function formatAPIUrl(route, query) {
            let apiUrl = route + '?';
            for (let key in query) {
                apiUrl += `${key}=${query[key]}&`
            }
            return apiUrl.slice(0, -1);
        }

        // 事件监听
        let key = true;
        window.onscroll = async () => {
            // header的显示与隐藏
            if ($(window).scrollTop() > 100) {
                $('header a').slideUp('fast');
            } else {
                $('header a').slideDown('fast')
            }

            // 加载新批次数据
            const pageHeight = document.body.scrollHeight;
            const scrollHeight = window.scrollY + 572;
            if (scrollHeight >= 0.8 * pageHeight && key) {
                key = false;
                query.offset += query.limit;
                const batchData = await getBatch(query);
                if (batchData) {
                    key = true;
                }
            }
        }
        
        $('.main-container').delegate('.waterfall-item', 'mouseenter', function () {
            $(this).find('.info-container').stop().fadeIn(300);
        });
        $('.main-container').delegate('.waterfall-item', 'mouseleave', function () {
            $(this).find('.info-container').stop().fadeOut(300);
        });


        let timer;
        $('.back-to-top').click(() => {
            timer = setInterval(() => {
                if ($(window).scrollTop() >= 100) {
                    window.scrollBy(0, -100);
                } else if ($(window).scrollTop() > 0) {
                    window.scrollBy(0, -10);
                } 

                if ($(window).scrollTop() === 0) {
                    clearInterval(timer);
                }
            }, 1)
        })
	</script>
</html>
